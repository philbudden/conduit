name: Validate GitOps Repository

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  lint:
    name: Lint YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: yamllint -c .yamllint.yaml .

  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main
        with:
          version: 'v2.4.0'

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.5.0'

      - name: Setup kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate with Flux
        run: |
          # Build and validate Flux Kustomization syntax
          # flux build kustomization requires cluster access, so we validate structure instead
          echo "Validating Flux Kustomization resources..."

          # Check that all Kustomization resources have required fields
          for file in clusters/blueberry-k3s/infrastructure.yaml clusters/blueberry-k3s/flux-system/gotk-sync.yaml; do
            echo "Checking $file..."
            if ! grep -q "apiVersion: kustomize.toolkit.fluxcd.io" "$file"; then
              echo "ERROR: $file missing Flux Kustomization apiVersion"
              exit 1
            fi
            if ! grep -q "sourceRef:" "$file"; then
              echo "ERROR: $file missing sourceRef"
              exit 1
            fi
          done

          # Validate HelmRelease resources
          for hr in infrastructure/monitoring/*-helmrelease.yaml; do
            echo "Checking HelmRelease: $hr..."
            if ! grep -q "apiVersion: helm.toolkit.fluxcd.io/v2" "$hr"; then
              echo "ERROR: $hr has incorrect apiVersion"
              exit 1
            fi
            if ! grep -q "chart:" "$hr"; then
              echo "ERROR: $hr missing chart specification"
              exit 1
            fi
            if ! grep -q "version:" "$hr"; then
              echo "ERROR: $hr missing chart version (must be pinned)"
              exit 1
            fi
          done

          echo "âœ“ Flux resource validation passed"

      - name: Validate cluster manifests
        run: |
          kustomize build clusters/blueberry-k3s > /tmp/blueberry-k3s.yaml
          kubeconform -strict -ignore-missing-schemas -skip CustomResourceDefinition /tmp/blueberry-k3s.yaml

      - name: Validate infrastructure
        run: |
          kustomize build infrastructure > /tmp/infrastructure.yaml
          kubeconform -strict -ignore-missing-schemas \
            -skip CustomResourceDefinition,HelmRelease,HelmRepository,GitRepository,Kustomization \
            /tmp/infrastructure.yaml

  check-image-tags:
    name: Check for :latest tags
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for :latest image tags
        run: |
          if grep -r "image:.*:latest" clusters/ infrastructure/ apps/ 2>/dev/null; then
            echo "ERROR: Found ':latest' image tags. All images must be pinned."
            exit 1
          fi
          echo "OK: No ':latest' tags found"

  check-namespaces:
    name: Ensure explicit namespaces
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup yq
        run: |
          wget https://github.com/mikefarah/yq/releases/download/v4.44.6/yq_linux_amd64 -O /tmp/yq
          sudo mv /tmp/yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Check for missing namespaces
        run: |
          # This is a simplified check
          # In production, you'd want more sophisticated validation
          echo "Namespace validation placeholder - implement based on team needs"
